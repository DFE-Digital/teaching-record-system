name: Pull request build

on:
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

permissions:
  checks: write
  deployments: write
  packages: write
  pull-requests: write
  id-token: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-22.04  # Important - later versions of ubuntu have a different .NET SDK which breaks trscli. Review on .NET 9 upgrade

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - uses: extractions/setup-just@v3

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Install tools
        run: just install-tools

      - name: Lint
        run: |
          git fetch origin main --quiet --depth=1

          CHANGED_FILES=$(git diff --name-only origin/main $GITHUB_SHA)
          GLOBAL_SETTINGS_CHANGED=$(echo "$CHANGED_FILES" | grep -c -e '\.csproj$' -e '\.editorconfig$' -e '\.props$')
          CS_FILES_CHANGED=$(echo "$CHANGED_FILES" | grep -c -e '\.cs$')

          if [ "$GLOBAL_SETTINGS_CHANGED" -gt 0 ]; then
            INCLUDE_ARG=""
            echo "::notice::Linting entire .NET solution"
          elif [ "$CS_FILES_CHANGED" -eq 0 ]; then
            echo "::notice::No changes to lint"
            exit 0
          else
            INCLUDE_ARG="--include $(echo "CS_FILES_CHANGED" | sed 's/^TeachingRecordSystem\///g' | tr '\n' ' ')"
          fi

          cd TeachingRecordSystem && dotnet dotnet-format --verify-no-changes $INCLUDE_ARG

  validate_terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Check formatting
        run: terraform fmt -check -diff
        working-directory: terraform/aks

      - name: Download terraform modules
        run: make ci dev vendor-modules

      - name: Validate
        run: |
          terraform init -backend=false
          terraform validate -no-color
        working-directory: terraform/aks

      - name: Lint
        uses: reviewdog/action-tflint@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tflint_rulesets: azurerm
          working_directory: terraform/aks
        continue-on-error: true # temporary- we're getting sporadic 503 errors here in action setup

  get_affected_projects:
    name: Get affected projects
    runs-on: ubuntu-latest

    outputs:
      project_short_names: ${{ steps.get_test_projects.outputs.project_short_names }}

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: extractions/setup-just@v3

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Install tools
        run: just install-tools

      - name: Get test projects
        id: get_test_projects
        run: |
          set -eo pipefail

          git fetch origin $TARGET_BRANCH --quiet

          TARGET_BRANCH=main
          TEST_PROJECTS_LIST=${{ runner.temp }}/test_projects.txt

          # If this is a merge queue build and there's only a single item in the queue, we can skip tests
          # (as we've already run them in the PR build)
          if [ "${{ github.event_name }}" == "merge_group" ]; then
            MERGE_QUEUE_LENGTH=$(git rev-list --no-merges --count origin/${TARGET_BRANCH}..)
            echo "Merge queue length: $MERGE_QUEUE_LENGTH"
            if [ "$MERGE_QUEUE_LENGTH" == "1" ]; then
              echo "project_short_names=[]" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          dotnet incrementalist run --file $TEST_PROJECTS_LIST --branch $TARGET_BRANCH --dir ../ --target-glob "**/*Tests.csproj"

          # Check projects with Razor views individually as incrementalist doesn't currently know about them
          CHANGED_FILES=$(git diff --name-only origin/$TARGET_BRANCH $GITHUB_SHA)
          if [[ $(echo "$CHANGED_FILES" | grep -El "TeachingRecordSystem.SupportUi") ]]; then
            echo -n -e "\n$(realpath "tests/TeachingRecordSystem.SupportUi.Tests/TeachingRecordSystem.SupportUi.Tests.csproj")" >> $TEST_PROJECTS_LIST
            echo -n -e "\n$(realpath "tests/TeachingRecordSystem.SupportUi.EndToEndTests/TeachingRecordSystem.SupportUi.EndToEndTests.csproj")" >> $TEST_PROJECTS_LIST
          fi
          if [[ $(echo "$CHANGED_FILES" | grep -El "TeachingRecordSystem.AuthorizeAccess") ]]; then
            echo -n -e "\n$(realpath "tests/TeachingRecordSystem.AuthorizeAccess.Tests/TeachingRecordSystem.AuthorizeAccess.Tests.csproj")" >> $TEST_PROJECTS_LIST
            echo -n -e "\n$(realpath "tests/TeachingRecordSystem.AuthorizeAccess.EndToEndTests/TeachingRecordSystem.AuthorizeAccess.EndToEndTests.csproj")" >> $TEST_PROJECTS_LIST
          fi

          echo "project_short_names=$(cat $TEST_PROJECTS_LIST | sort | uniq | xargs -n 1 dirname | xargs -n 1 basename | sed 's/^TeachingRecordSystem\.//g' | jq -c --raw-input --slurp 'split("\n") | .[0:-1]')" >> $GITHUB_OUTPUT
        working-directory: TeachingRecordSystem

  tests:
    name: Tests
    runs-on: ubuntu-22.04  # Important - later versions of ubuntu have a different .NET SDK which breaks trscli. Review on .NET 9 upgrade
    needs: [get_affected_projects]
    if: needs.get_affected_projects.outputs.project_short_names != '[]'
    strategy:
      fail-fast: false
      matrix:
        project_short_name: ${{ fromJson(needs.get_affected_projects.outputs.project_short_names) }}

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: trs
          POSTGRES_DB: trs
        options: >-
          --name postgres
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Set postgres wal_level to logical
        run: |
          docker exec -i postgres bash << EOF
          echo "wal_level = logical" >> /var/lib/postgresql/data/postgresql.conf
          EOF

          docker restart --time 0 postgres

      - uses: actions/checkout@v5

      - uses: extractions/setup-just@v3

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Install tools
        run: just install-tools

      - name: Restore cached packages
        id: cache-packages-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.local/share/.librarymanager/cache
          key: ${{ hashFiles('**/packages.lock.json', '**/libman.json') }}

      - name: Restore
        run: just restore

      - name: Cache restored packages
        id: cache-packages-save
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.local/share/.librarymanager/cache
          key: ${{ steps.cache-packages-restore.outputs.cache-primary-key }}
        if: steps.cache-packages-restore.outputs.cache-hit != 'true'

      - name: Build project
        run: dotnet build -c Release --no-restore
        working-directory: TeachingRecordSystem/tests/TeachingRecordSystem.${{ matrix.project_short_name }}

      - name: Install Playwright if required
        run: |
          if [[ "$PROJECT_NAME" =~ .*EndToEndTests ]]; then
            pwsh ./bin/Release/net9.0/playwright.ps1 install chromium
          fi
        working-directory: TeachingRecordSystem/tests/TeachingRecordSystem.${{ matrix.project_short_name }}
        env:
          PROJECT_NAME: ${{ matrix.project_short_name }}

      - name: Run tests
        uses: ./.github/workflows/actions/test
        with:
          test_project_path: TeachingRecordSystem/tests/TeachingRecordSystem.${{ matrix.project_short_name }}
          report_name: "${{ matrix.project_short_name }} test results"
          dotnet_test_args: >-
            --no-build
            -e ConnectionStrings__DefaultConnection="Host=localhost;Username=postgres;Password=trs;Database=trs"
        timeout-minutes: 30

  check_test_results:
    name: Check test results
    runs-on: ubuntu-latest
    needs: [tests]
    if: always()
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const testsStepResult = '${{ needs.tests.result }}';

            if (testsStepResult === 'failure') {
              core.setFailed('Required tests failed.');
            }

  package:
    name: Package application
    uses: ./.github/workflows/package.yml
    secrets: inherit
