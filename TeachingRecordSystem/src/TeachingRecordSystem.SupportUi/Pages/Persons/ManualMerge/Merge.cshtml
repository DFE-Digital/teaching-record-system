@page "/persons/{personId}/manual-merge/merge"
@using TeachingRecordSystem.SupportUi.Pages.Persons.ManualMerge
@model TeachingRecordSystem.SupportUi.Pages.Persons.ManualMerge.MergeModel
@{
    Layout = "_Layout";
    ViewBag.Title = "Select the details to merge into the primary record";
}

@section BeforeContent {
    <govuk-back-link data-testid="back-link" href="@Model.BackLink" />
}

@functions {
#pragma warning disable CS1998
    private async Task RenderWithHighlightIfDifferent(string? value, bool different)
    {
        if (string.IsNullOrEmpty(value))
        {
            value = UiDefaults.EmptyDisplayContent;
        }

        if (different)
        {
            <highlight>@value</highlight>
        }
        else
        {
            @value
        }
    }
#pragma warning restore CS1998
}

<form action="@Model.GetPageLink(ManualMergeJourneyPage.Merge)" method="post" enctype="multipart/form-data" data-testid="submit-form">
    <span class="govuk-caption-l">Support tasks</span>
    <h1 class="govuk-heading-l">@ViewBag.Title</h1>

    <div style="display: flex">
        <div class="govuk-heading-m govuk-!-width-one-half">
            Primary record (TRN @Model.Trn!.PrimaryRecordValue)
        </div>
        <div class="govuk-heading-m govuk-!-width-one-half">
            Secondary record (TRN @Model.Trn!.SecondaryRecordValue)
        </div>
    </div>

        <table class="govuk-table">
        <tbody class="govuk-table__body">
            @* Annoyingly we can't wrap this markup into a function because there's no way to pass a ModelExpression to bind to
              https://github.com/dotnet/aspnetcore/issues/45845
             *@
            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="FirstNameSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.FirstName!.Different)">
                                @(Model.FirstName!.PrimaryRecordValue ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.FirstName!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.FirstName!.SecondaryRecordValue, Model.FirstName.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>

            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="MiddleNameSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.MiddleName!.Different)">
                                @(Model.MiddleName!.PrimaryRecordValue.ToNullIfEmpty() ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.MiddleName!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.MiddleName!.SecondaryRecordValue, Model.MiddleName.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>

            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="LastNameSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.LastName!.Different)">
                                @(Model.LastName!.PrimaryRecordValue.ToNullIfEmpty() ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.LastName!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.LastName!.SecondaryRecordValue, Model.LastName.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>

            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="DateOfBirthSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.DateOfBirth!.Different)">
                                @(Model.DateOfBirth!.PrimaryRecordValue?.ToString(UiDefaults.DateOnlyDisplayFormat) ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.DateOfBirth!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.DateOfBirth!.SecondaryRecordValue?.ToString(UiDefaults.DateOnlyDisplayFormat), Model.DateOfBirth.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>

            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="EmailAddressSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.EmailAddress!.Different)">
                                @(Model.EmailAddress!.PrimaryRecordValue?.ToNullIfEmpty() ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.EmailAddress!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.EmailAddress!.SecondaryRecordValue, Model.EmailAddress.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>

            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="NationalInsuranceNumberSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.NationalInsuranceNumber!.Different)">
                                @(Model.NationalInsuranceNumber!.PrimaryRecordValue?.ToNullIfEmpty() ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.NationalInsuranceNumber!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.NationalInsuranceNumber!.SecondaryRecordValue, Model.NationalInsuranceNumber.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>

            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <govuk-radios asp-for="GenderSource" class="govuk-!-margin-bottom-0" radios-class="trs-radios--inline-two-column">
                        <govuk-radios-fieldset>
                            <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s"/>
                            <govuk-radios-item value="@PersonAttributeSource.PrimaryRecord" disabled="@(!Model.Gender!.Different)">
                                @(Model.Gender!.PrimaryRecordValue?.GetDisplayName() ?? UiDefaults.EmptyDisplayContent)
                            </govuk-radios-item>
                            <govuk-radios-item value="@PersonAttributeSource.SecondaryRecord" disabled="@(!Model.Gender!.Different)">
                                @{ await RenderWithHighlightIfDifferent(Model.Gender!.SecondaryRecordValue?.GetDisplayName(), Model.Gender.Different); }
                            </govuk-radios-item>
                        </govuk-radios-fieldset>
                    </govuk-radios>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds-from-desktop">
            <govuk-radios asp-for="UploadEvidence" data-testid="upload-evidence-options">
                <govuk-radios-fieldset>
                    <govuk-radios-fieldset-legend class="govuk-fieldset__legend--m" data-testid="upload-evidence-options-legend" />
                    <govuk-radios-item value="@true">
                        Yes
                        <govuk-radios-item-conditional>
                            @if (Model.EvidenceFileId is not null)
                            {
                                <span class="govuk-caption-m">Currently uploaded file</span>
                                <p class="govuk-body">
                                    <a href="@Model.EvidenceFileUrl" class="govuk-link" rel="noreferrer noopener" target="_blank" data-testid="uploaded-evidence-file-link">@($"{Model.EvidenceFileName} ({Model.EvidenceFileSizeDescription})")</a>
                                </p>
                                <input type="hidden" asp-for="EvidenceFileId" />
                                <input type="hidden" asp-for="EvidenceFileName" />
                                <input type="hidden" asp-for="EvidenceFileSizeDescription" />
                                <input type="hidden" asp-for="EvidenceFileUrl" />
                            }
                            <govuk-file-upload asp-for="EvidenceFile" 
                                               label-class="govuk-label--m"
                                               input-accept=".bmp, .csv, .doc, .docx, .eml, .jpeg, .jpg, .mbox, .msg, .ods, .odt, .pdf, .png, .tif, .txt, .xls, .xlsx">
                                <govuk-file-upload-label>Upload a file</govuk-file-upload-label>
                                <govuk-file-upload-hint>Must be smaller than 50MB</govuk-file-upload-hint>
                            </govuk-file-upload>
                        </govuk-radios-item-conditional>
                    </govuk-radios-item>
                    <govuk-radios-item value="@false">
                        No
                    </govuk-radios-item>
                </govuk-radios-fieldset>
            </govuk-radios>

            <govuk-textarea asp-for="Comments" label-class="govuk-label--s" />

            <p class="govuk-body govuk-!-font-size-24 govuk-!-font-weight-bold">Do you want to use these details in the primary record?</p>

            <govuk-warning-text>
                The secondary record will be deactivated once it’s merged with the primary record, but you’ll still be able to view it.
            </govuk-warning-text>

            <div class="govuk-button-group">
                <govuk-button type="submit" data-testid="continue-button">Continue</govuk-button>
                <govuk-button formaction="@Model.CancelLink" class="govuk-button--secondary" type="submit" data-testid="cancel-button">Cancel and return to record</govuk-button>
            </div>
        </div>
    </div>

</form>
