@page "/persons/{personId}"
@using TeachingRecordSystem.SupportUi.Pages.Shared

@model TeachingRecordSystem.SupportUi.Pages.Persons.PersonDetail.IndexModel

@{
    Layout = "Layout";
    ViewBag.SelectedTab = PersonDetailSubNavigationTab.General;
}

@if (Model.HasOpenAlert)
{
    <govuk-notification-banner data-testid="open-alert-notification">
        <p class="govuk-notification-banner__heading">
            Alert on record.
            <a class="govuk-notification-banner__link" href="@LinkGenerator.Persons.PersonDetail.Alerts(Model.PersonId)">View alerts</a>
        </p>
    </govuk-notification-banner>
}

@if (Model.ConnectedOneLoginUsers?.Length > 0)
{
    <govuk-summary-card data-testid="associated-one-login-users">
        <govuk-summary-card-title>Connected GOV.UK One Login details
        </govuk-summary-card-title>
        <govuk-summary-list>
            @foreach (var user in Model.ConnectedOneLoginUsers)
            {
                <govuk-summary-list-row>
                    <govuk-summary-list-row-key>Email address</govuk-summary-list-row-key>
                    <govuk-summary-list-row-value>@user.EmailAddress</govuk-summary-list-row-value>
                    @if (Model.CanConnectOneLogin)
                    {
                        <govuk-summary-list-row-actions>
                            <govuk-summary-list-row-action
                                href="@LinkGenerator.Persons.PersonDetail.DisconnectOneLogin.DisconnectOneLoginSubject(Model.PersonId, user.Subject, journeyInstanceId: null)"
                                visually-hidden-text="@user.EmailAddress">
                                Disconnect
                            </govuk-summary-list-row-action>
                        </govuk-summary-list-row-actions>
                    }
                </govuk-summary-list-row>
            }
        </govuk-summary-list>
    </govuk-summary-card>
}

@{
    var personDetailModel = new PersonDetailViewModel()
    {
        PersonId = Model.PersonId,
        Options = PersonDetailViewModelOptions.ShowAll,
        Trn = Model.Person!.Trn,
        Name = Model.Person.Name,
        PreviousNames = Model.Person.PreviousNames,
        DateOfBirth = Model.Person.DateOfBirth,
        NationalInsuranceNumber = Model.Person.NationalInsuranceNumber,
        Gender = Model.Person.Gender,
        Email = Model.Person.Email,
        CanChangeDetails = Model.CanChangeDetails,
        IsActive = Model.Person.IsActive
    };
}
@await Html.PartialAsync("_PersonDetail", personDetailModel)

@if (Model.PersonProfessionalStatus is not null)
{
    <govuk-summary-card>
        <govuk-summary-card-title data-testid="professional-status-details">Professional status details</govuk-summary-card-title>
        <govuk-summary-list>
            <govuk-summary-list-row>
                <govuk-summary-list-row-key>Qualified teacher status (QTS)</govuk-summary-list-row-key>
                <govuk-summary-list-row-value>@(Model.PersonProfessionalStatus.QtsDate != null ? "Holds" : "No")</govuk-summary-list-row-value>
            </govuk-summary-list-row>
            @if (Model.PersonProfessionalStatus.QtsDate is not null)
            {
                <govuk-summary-list-row>
                    <govuk-summary-list-row-key>QTS held since</govuk-summary-list-row-key>
                    <govuk-summary-list-row-value>@Model.PersonProfessionalStatus.QtsDate?.ToString(WebConstants.DateOnlyDisplayFormat)</govuk-summary-list-row-value>
                </govuk-summary-list-row>
            }
            <govuk-summary-list-row>
                <govuk-summary-list-row-key>Qualified teacher learning and skills status (QTLS)</govuk-summary-list-row-key>
                <govuk-summary-list-row-value>@(Model.PersonProfessionalStatus.QtlsStatus == QtlsStatus.None ? "No" : Model.PersonProfessionalStatus.QtlsStatus.ToString())</govuk-summary-list-row-value>
            </govuk-summary-list-row>
            @if (Model.PersonProfessionalStatus.InductionStatus != InductionStatus.None)
            {
                <govuk-summary-list-row>
                    <govuk-summary-list-row-key>Induction status</govuk-summary-list-row-key>
                    <govuk-summary-list-row-value>@Model.PersonProfessionalStatus.InductionStatus.GetTitle()</govuk-summary-list-row-value>
                </govuk-summary-list-row>
            }
            <govuk-summary-list-row>
                <govuk-summary-list-row-key>Early years teacher status (EYTS)</govuk-summary-list-row-key>
                <govuk-summary-list-row-value>@(Model.PersonProfessionalStatus.EytsDate is not null ? "Holds" : "No")</govuk-summary-list-row-value>
            </govuk-summary-list-row>
            @if (Model.PersonProfessionalStatus.EytsDate is not null)
            {
                <govuk-summary-list-row>
                    <govuk-summary-list-row-key>EYTS held since</govuk-summary-list-row-key>
                    <govuk-summary-list-row-value>@Model.PersonProfessionalStatus.EytsDate?.ToString(WebConstants.DateOnlyDisplayFormat)</govuk-summary-list-row-value>
                </govuk-summary-list-row>
            }
            <govuk-summary-list-row>
                <govuk-summary-list-row-key>Early years professional status (EYPS)</govuk-summary-list-row-key>
                <govuk-summary-list-row-value>@(Model.PersonProfessionalStatus.HasEyps ? "Holds" : "No")</govuk-summary-list-row-value>
            </govuk-summary-list-row>
            <govuk-summary-list-row>
                <govuk-summary-list-row-key>Partial qualified teacher status (PQTS)</govuk-summary-list-row-key>
                <govuk-summary-list-row-value>@(Model.PersonProfessionalStatus.PqtsDate != null ? "Holds" : "No")</govuk-summary-list-row-value>
            </govuk-summary-list-row>
            @if (Model.PersonProfessionalStatus.PqtsDate is not null)
            {
                <govuk-summary-list-row>
                    <govuk-summary-list-row-key>PQTS held since</govuk-summary-list-row-key>
                    <govuk-summary-list-row-value>@Model.PersonProfessionalStatus.PqtsDate?.ToString(WebConstants.DateOnlyDisplayFormat)</govuk-summary-list-row-value>
                </govuk-summary-list-row>
            }
        </govuk-summary-list>
    </govuk-summary-card>
}

<div class="govuk-button-group">
    @if (Model.CanConnectOneLogin)
    {
        <govuk-button-link data-testid="connect-one-login-button" href="@LinkGenerator.Persons.PersonDetail.ConnectOneLogin.Index(Model.PersonId)">Connect record to GOV.UK One Login</govuk-button-link>
    }

    @if (Model.CanSetStatus)
    {
        <govuk-button-link
            data-testid="set-status-button"
            href="@LinkGenerator.Persons.PersonDetail.SetStatus.Index(Model.PersonId, Model.Person.IsActive ? PersonStatus.Deactivated : PersonStatus.Active)"
            class="govuk-button--secondary">
            @(Model.Person.IsActive ? "Deactivate" : "Reactivate") record
        </govuk-button-link>
    }

    @if (Model.CanMerge)
    {
        <govuk-button-link data-testid="merge-button" href="@LinkGenerator.Persons.MergePerson.Index(Model.PersonId)" class="govuk-button--secondary">Merge with another record</govuk-button-link>
    }
</div>
