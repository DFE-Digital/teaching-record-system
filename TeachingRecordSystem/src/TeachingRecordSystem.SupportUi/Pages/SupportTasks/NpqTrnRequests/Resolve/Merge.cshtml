@page "/support-tasks/npq-trn-requests/{supportTaskReference}/resolve/merge/{handler?}"
@using TeachingRecordSystem.SupportUi.Pages.Shared
@using TeachingRecordSystem.SupportUi.Services
@using static TeachingRecordSystem.SupportUi.Pages.SupportTasks.NpqTrnRequests.Resolve.ResolveNpqTrnRequestState
@model TeachingRecordSystem.SupportUi.Pages.SupportTasks.NpqTrnRequests.Resolve.MergeModel
@{
    ViewBag.Title = $"Select the details to merge into {Model.PersonName}'s record";
}

@section BeforeContent {
    <govuk-back-link href="@(Model.FromCheckAnswers ?
        LinkGenerator.SupportTasks.NpqTrnRequests.Resolve.CheckAnswers(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId) :
        LinkGenerator.SupportTasks.NpqTrnRequests.Resolve.Matches(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId))" />
}

@functions {
#pragma warning disable CS1998
    private async Task RenderChoosePersonAttribute(
        string label,
        bool different,
        bool highlight,
        string name,
        string? leftLabel,
        string? rightLabel,
        PersonAttributeSource? selectedValue)
    {
        var chooseAttributeModel = new ChoosePersonAttributeViewModel()
        {
            Label = label,
            Different = different,
            Highlight = highlight,
            Name = name,
            LeftValue = PersonAttributeSource.TrnRequest,
            LeftLabel = leftLabel,
            RightValue = PersonAttributeSource.ExistingRecord,
            RightLabel = rightLabel,
            SelectedValue = selectedValue
        };
        <partial name="Shared/_ChoosePersonAttribute" model="@chooseAttributeModel" />
    }
#pragma warning restore CS1998
}

<form action="@LinkGenerator.SupportTasks.NpqTrnRequests.Resolve.Merge(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId)" method="post">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds-from-desktop">
            <span class="govuk-caption-l">TRN requests</span>
            <h1 class="govuk-heading-l">@ViewBag.Title</h1>
        </div>
    </div>

    <div class="trs-display-flex">
        <div class="govuk-heading-m govuk-!-width-one-half">
            @Model.SourceApplicationUserName request
        </div>
        <div class="govuk-heading-m govuk-!-width-one-half">
            Existing record
        </div>
    </div>

    <table class="govuk-table">
        <tbody class="govuk-table__body">
            @{

                await RenderChoosePersonAttribute(
                    "Date of birth",
                    Model.DateOfBirth!.Different,
                    Model.DateOfBirth!.Highlight,
                    Html.NameFor(m => m.DateOfBirthSource),
                    Model.DateOfBirth!.TrnRequestValue?.ToString(WebConstants.DateOnlyDisplayFormat),
                    Model.DateOfBirth!.ExistingRecordValue?.ToString(WebConstants.DateOnlyDisplayFormat),
                    Model.DateOfBirthSource);

                await RenderChoosePersonAttribute(
                    "Email",
                    Model.EmailAddress!.Different,
                    Model.EmailAddress!.Highlight,
                    Html.NameFor(m => m.EmailAddressSource),
                    Model.EmailAddress!.TrnRequestValue,
                    Model.EmailAddress!.ExistingRecordValue,
                    Model.EmailAddressSource);

                await RenderChoosePersonAttribute(
                    "National Insurance number",
                    Model.NationalInsuranceNumber!.Different,
                    Model.NationalInsuranceNumber!.Highlight,
                    Html.NameFor(m => m.NationalInsuranceNumberSource),
                    Model.NationalInsuranceNumber!.TrnRequestValue,
                    Model.NationalInsuranceNumber!.ExistingRecordValue,
                    Model.NationalInsuranceNumberSource);

                await RenderChoosePersonAttribute(
                    "Gender",
                    Model.Gender!.Different,
                    Model.Gender!.Highlight,
                    Html.NameFor(m => m.GenderSource),
                    Model.Gender!.TrnRequestValue?.GetDisplayName(),
                    Model.Gender!.ExistingRecordValue?.GetDisplayName(),
                    Model.GenderSource);
            }
        </tbody>
    </table>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds-from-desktop">
            <govuk-textarea for="Comments" label-class="govuk-label--s">
                <govuk-textarea-label class="govuk-label--s">Add comments (optional)</govuk-textarea-label>
            </govuk-textarea>

            <govuk-warning-text>
                This task will be marked as complete after the record has been updated.
            </govuk-warning-text>

            <div class="govuk-button-group">
                <govuk-button type="submit">Continue</govuk-button>
                <govuk-button type="submit" formaction="@LinkGenerator.SupportTasks.NpqTrnRequests.Resolve.MergeCancel(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId)" class="govuk-button--secondary" data-testid="cancel-button">Cancel</govuk-button>
            </div>
        </div>
    </div>
</form>
