@page "/support-tasks/teacher-pensions/{supportTaskReference}/resolve/matches/{handler?}"
@using TeachingRecordSystem.SupportUi.Pages.Shared
@addTagHelper *, Joonasw.AspNetCore.SecurityHeaders
@model TeachingRecordSystem.SupportUi.Pages.SupportTasks.TeacherPensions.Resolve.Matches
@{
    ViewBag.Title = "Compare Teachersâ€™ Pensions record with potential matches";

}

@section BeforeContent {
    <govuk-back-link href="@(Model.FromCheckAnswers ?  LinkGenerator.TeacherPensionsCheckAnswers(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId) :  LinkGenerator.TeacherPensions())" />
}

<form action="@LinkGenerator.TeacherPensionsMatches(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId)" method="post">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds-from-desktop">
            <span class="govuk-caption-l">Support tasks</span>
            <h1 class="govuk-heading-l">@ViewBag.Title</h1>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half-from-desktop">
            <govuk-inset-text class="govuk-!-margin-top-0">
                Differences are <highlight>highlighted</highlight> in the matched record
            </govuk-inset-text>

            <govuk-summary-card data-testid="request">
                <govuk-summary-card-title>
                    Teachers&rsquo; Pensions record
                </govuk-summary-card-title>
                <govuk-summary-card-actions>
                    <govuk-summary-card-action href="@LinkGenerator.PersonDetail(Model.SupportTask!.PersonId!.Value)" target="_blank">
                        View record
                    </govuk-summary-card-action>
                </govuk-summary-card-actions>
                <govuk-summary-list>
                    <govuk-summary-list-row>
                        <govuk-summary-list-row-key>First name</govuk-summary-list-row-key>
                        <govuk-summary-list-row-value use-empty-fallback>@Model.RequestData!.FirstName</govuk-summary-list-row-value>
                    </govuk-summary-list-row>
                    <govuk-summary-list-row>
                        <govuk-summary-list-row-key>Last name</govuk-summary-list-row-key>
                        <govuk-summary-list-row-value use-empty-fallback>@Model.RequestData!.LastName</govuk-summary-list-row-value>
                    </govuk-summary-list-row>
                    <govuk-summary-list-row>
                        <govuk-summary-list-row-key>TRN</govuk-summary-list-row-key>
                        <govuk-summary-list-row-value use-empty-fallback>@Model.Trn</govuk-summary-list-row-value>
                    </govuk-summary-list-row>
                    <govuk-summary-list-row>
                        <govuk-summary-list-row-key>Date of birth</govuk-summary-list-row-key>
                        <govuk-summary-list-row-value use-empty-fallback>@Model.RequestData!.DateOfBirth.ToString(UiDefaults.DateOnlyDisplayFormat)</govuk-summary-list-row-value>
                    </govuk-summary-list-row>
                    <govuk-summary-list-row>
                        <govuk-summary-list-row-key>NI number</govuk-summary-list-row-key>
                        <govuk-summary-list-row-value use-empty-fallback>@Model.RequestData!.NationalInsuranceNumber</govuk-summary-list-row-value>
                    </govuk-summary-list-row>
                    <govuk-summary-list-row>
                        <govuk-summary-list-row-key>Gender</govuk-summary-list-row-key>
                        <govuk-summary-list-row-value use-empty-fallback>@Model.RequestData!.Gender?.GetDisplayName()</govuk-summary-list-row-value>
                    </govuk-summary-list-row>

                </govuk-summary-list>
            </govuk-summary-card>
        </div>
    </div>

    <div class="govuk-grid-row">
        <h2 class="govuk-heading-m">Potential matches</h2>

        @foreach (var match in Model.PotentialDuplicates!)
        {
            <div class="govuk-grid-column-one-half-from-desktop">
                <govuk-summary-card data-testid="match">
                    <govuk-summary-card-title>
                        Record @match.Identifier
                    </govuk-summary-card-title>
                    <govuk-summary-card-actions>
                        <govuk-summary-card-action href="@LinkGenerator.PersonDetail(match.PersonId)" target="_blank">
                            View record
                        </govuk-summary-card-action>
                    </govuk-summary-card-actions>
                    <govuk-summary-list>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>First name</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.FirstName))">
                                @match.FirstName
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>Middle name</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.MiddleName))">
                                @match.MiddleName
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>Last name</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.LastName))">
                                @match.LastName
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>TRN</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.Trn))">
                                @match.Trn
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>Date of birth</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.DateOfBirth))">
                                @match.DateOfBirth?.ToString(UiDefaults.DateOnlyDisplayFormat)
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>NI number</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.NationalInsuranceNumber))">
                                @match.NationalInsuranceNumber
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                        <govuk-summary-list-row>
                            <govuk-summary-list-row-key>Gender</govuk-summary-list-row-key>
                            <govuk-summary-list-row-value use-empty-fallback highlight="@(!match.MatchedAttributes.Contains(PersonMatchedAttribute.Gender))">
                                @match.Gender?.GetDisplayName()
                            </govuk-summary-list-row-value>
                        </govuk-summary-list-row>
                    </govuk-summary-list>
                </govuk-summary-card>
            </div>
        }
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds-from-desktop">
            <govuk-radios asp-for="PersonId">
                <govuk-radios-fieldset>
                    <govuk-radios-fieldset-legend class="govuk-fieldset__legend--m">
                        What do you want to do with the Teachers&rsquo; Pensions request?
                    </govuk-radios-fieldset-legend>

                    @foreach (var match in Model.PotentialDuplicates!)
                    {
                        <govuk-radios-item value="@match.PersonId">
                            Merge it with Record @match.Identifier
                        </govuk-radios-item>
                    }

                    <govuk-radios-divider>or</govuk-radios-divider>

                    <govuk-radios-item value="@Guid.Empty">
                        Keep it as a separate record
                    </govuk-radios-item>
                </govuk-radios-fieldset>
            </govuk-radios>

            <div class="govuk-button-group">
                <govuk-button type="submit">Continue</govuk-button>
                <govuk-button type="submit" formaction="@LinkGenerator.TeacherPensionsMatchesCancel(Model.SupportTaskReference!, Model.JourneyInstance!.InstanceId)" class="govuk-button--secondary">Cancel</govuk-button>
            </div>
        </div>
    </div>
</form>
