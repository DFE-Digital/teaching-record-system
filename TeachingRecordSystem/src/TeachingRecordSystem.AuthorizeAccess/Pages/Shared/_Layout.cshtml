@inject Joonasw.AspNetCore.SecurityHeaders.Csp.ICspNonceService NonceService
@inject IJourneyInstanceProvider JourneyInstanceProvider
@addTagHelper *, Joonasw.AspNetCore.SecurityHeaders
@{
    Layout = "_GovUkPageTemplate";

    if (ViewBag.Title is null)
    {
        throw new InvalidOperationException("ViewBag.Title must be set.");
    }

    if (ViewBag.ServiceName is not null)
    {
        ViewBag.Title += $" - {ViewBag.ServiceName}";
    }
}

@section Head {
    <meta name="robots" content="noindex">
    <link rel="stylesheet" asp-href-include="~/Styles/*.css" asp-append-version="true">
    @await RenderSectionAsync("Styles", required: false)
}

@section Header {
    @if (IsSectionDefined("Header"))
    {
        await RenderSectionAsync("Header");
    }
    else
    {
        var serviceName = ViewBag.ServiceName ?? throw new InvalidOperationException("ViewBag.ServiceName is not set.");
        var serviceUrl = ViewBag.ServiceUrl ?? throw new InvalidOperationException("ViewBag.ServiceUrl is not set.");

        await Html.RenderPartialAsync("./_OneLoginServiceHeader");

        <govuk-service-navigation service-name="@serviceName" service-url="@serviceUrl" />
    }
}

@section BeforeContent {
    @if (IsSectionDefined("BeforeContent"))
    {
        @await RenderSectionAsync("BeforeContent")
    }
    else if (JourneyInstanceProvider.GetJourneyInstance(Context) is SignInJourneyCoordinator signInJourneyCoordinator &&
        signInJourneyCoordinator.GetBackLink() is string backLink)
    {
        <govuk-back-link href="@backLink" />
    }
}

@RenderBody()

@section Footer {
    <govuk-footer />
}

@section BodyEnd {
    @Html.GovUkFrontendScriptImports(cspNonce: NonceService.GetNonce())
    <script type="module" asp-add-nonce>
        import { initCrossServiceHeader } from '/lib/govuk-one-login-service-header/dist/scripts/service-header.js';
        initCrossServiceHeader();
    </script>
    @await RenderSectionAsync("Scripts", required: false)
}
